<!DOCTYPE html>
<html>
	<head>
			<style>
				#board {
					line-height: 0;
				}
				.row {
				  
				}
				.tile {
					display: inline-block;
					height: 10px;
					width: 10px;
					margin: 0px 0px 0px 0px;
					padding: 0px 0px 0px 0px;
					border: 1px solid black;
				}

				.marked {
					background-color: black;
				}

			</style>
			<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
			<script>
				$(document).ready(function(){
				  game("board", 10, 20);
				});

				game = function(boardId, xSize, ySize){
					var board = $("#" + boardId);
					var body = $("body");
					var rowName = "row";
					var tileName = "tile";
					var grid = {};
					var xKey = "x";
					var yKey = "y";
					var marked = "marked";
					var livePiece = shapes.forwardsZ;

					init = function() {
						bindKeyup();
						buildGrid();
						pieceOperator(livePiece, markTile);
					};

					isInBounds = function(x, y) {
						return (x > 0 && x <= xSize && y > 0 && y <= ySize);
					};

					left = function(x, y) {
						var newX = x - 1;
						if(isInBounds(newX, y)) {
							return tileCoordinates(newX, y);
						};
					};

					right = function(x, y) {
						var newX = x + 1;
						if(isInBounds(newX, y)) {
							return tileCoordinates(newX, y);
						};
					};

					up = function(x, y) {
						var newY = y - 1;
						if(isInBounds(x, newY)) {
							return tileCoordinates(x, newY);
						};
					};

					down = function(x, y) {
						var newY = y + 1;
						if(isInBounds(x, newY)) {
							return tileCoordinates(x, newY);
						};
					};

					tileCoordinates = function(x, y) {
						return {
							x: x,
							y: y
						}
					}

					getTile = function(x, y) {
						return $("#" + tileName + "-" + x + "-" + y);
					};

					markTile = function(x, y) {
						getTile(x, y).addClass(marked);
					};

					unMarkTile = function(x, y) {
						getTile(x, y).removeClass(marked);
					};

					moveUp = function(x, y) {
						moveOperator(x, y, up);
					};

					moveDown = function(x, y) {
						moveOperator(x, y, down);
					};

					moveLeft = function(x, y) {
						moveOperator(x, y, left);
					};

					moveRight = function(x, y) {
						moveOperator(x, y, right);
					};

					clone = function(piece){
						var newPiece = [];
						pieceOperator(piece, function(x, y){
							newPiece.push({x: x, y: y});
						});
					};

					pieceOperator = function(piece, pieceFunction) {
						for(var i = 0; i < 4; i++) {
							pieceFunction(piece[i].x, piece[i].y);
						}
					};

					rotateLivePiece = function(direction){
						var newLivePiece = [];
						var isNewPieceValid = true;

						var centerX = livePiece[1].x;
						var centerY = livePiece[1].y;

						pieceOperator(livePiece, function(x, y){
							diffX = centerX - x;
							diffY = centerY - y;
							newLivePiece.push(tileCoordinates(centerX + diffY, centerY - diffX));
						});
						if (isNewPieceValid) {
							pieceOperator(livePiece, unMarkTile);
							pieceOperator(newLivePiece, markTile);
							livePiece = newLivePiece;
						};
					};

					moveLivePiece = function(direction) {
						var newLivePiece = [];
						var isNewPieceValid = true;

						pieceOperator(livePiece, function(x, y){
							var movedTile = direction(x,y);
							isNewPieceValid = isNewPieceValid && movedTile;
							newLivePiece.push(movedTile);
						});
						if (isNewPieceValid) {
							pieceOperator(livePiece, unMarkTile);
							pieceOperator(newLivePiece, markTile);
							livePiece = newLivePiece;
						};
					};

					buildGrid = function() {
						for (var i = 1; i <= ySize; i++) {
							var row = $("<div>", {id: rowName + "-" + i , class: rowName});
							board.append(row);
							for (var j = 1; j <= xSize; j++) {
								var tile = $("<span>", {id: tileName + "-" + j + "-" + i , class: tileName});
								row.append(tile);
							};
						};
					};

					bindKeyup = function() {
					    $(document).bind('keyup', function(e){
					      	if(e.which==40) {
						        moveLivePiece(down);
						    }
						    if(e.which==39) {
						        moveLivePiece(right);
						    }
						    if(e.which==38) {
						        //moveLivePiece(up);
						        rotateLivePiece();
						    }
						    if(e.which==37) {
						    	moveLivePiece(left);
						    }
					    });
					};

				//$("body").on("focus",":input", function(){ $(document).unbind('keyup'); });
				//$("body").on("blur",":input", function(){ bindKeyup(); });

					init();
				}

				var shapes = {
					square : [
						{x:1, y:1},
						{x:1, y:2},
						{x:2, y:1},
						{x:2, y:2}
					],

					forwardsL : [
						{x:1, y:1},
						{x:1, y:2},
						{x:1, y:3},
						{x:2, y:3}
					],

					backwardsL : [
						{x:2, y:1},
						{x:2, y:2},
						{x:2, y:3},
						{x:1, y:3}
					],

					forwardsZ : [
						{x:1, y:1},
						{x:1, y:2},
						{x:2, y:2},
						{x:2, y:3}
					],

					backwardsZ : [
						{x:2, y:1},
						{x:2, y:2},
						{x:1, y:2},
						{x:1, y:3}
					],

					line : [
						{x:1, y:1},
						{x:1, y:2},
						{x:1, y:3},
						{x:1, y:4}
					]
				};

			</script>
		</head>

	<body>
		<div id="board">
		</div>
	</body>
</html>
